


ARM Macro Assembler    Page 1 Serial I/O Driver


    1 00000000                 TTL              Serial I/O Driver
    2 00000000         ;****************************************************************
    3 00000000         ;Configures KL46Z for timer operations.
    4 00000000         ;Name:  Daniel Porten
    5 00000000         ;Date:  10/17/2017
    6 00000000         ;Class:  CMPE-250
    7 00000000         ;Section:  L1: Tuesday, 2-4PM
    8 00000000         ;---------------------------------------------------------------
    9 00000000         ;Keil Template for KL46
   10 00000000         ;R. W. Melton
   11 00000000         ;September 25, 2017
   12 00000000         ;****************************************************************
   13 00000000         ;Assembler directives
   14 00000000                 THUMB
   16 00000000         ;****************************************************************
   17 00000000         ;Include files
   18 00000000                 GET              MKL46Z4.s   ;Included by start.s
   20 00000000         ;****************************************************************
   21 00000000         ;EQUates
   22 00000000         ;---------------------------------------------------------------
   23 00000000         ;NVIC_ICER
   24 00000000         ;31-00:CLRENA=masks for HW IRQ sources;
   25 00000000         ;             read:   0 = unmasked;   1 = masked
   26 00000000         ;             write:  0 = no effect;  1 = mask
   27 00000000         ;22:PIT IRQ mask
   28 00000000         ;12:UART0 IRQ mask
   29 00000000 00400000 
                       NVIC_ICER_PIT_MASK
                               EQU              PIT_IRQ_MASK
   30 00000000 00001000 
                       NVIC_ICER_UART0_MASK
                               EQU              UART0_IRQ_MASK
   31 00000000         ;---------------------------------------------------------------
   32 00000000         ;NVIC_ICPR
   33 00000000         ;31-00:CLRPEND=pending status for HW IRQ sources;
   34 00000000         ;             read:   0 = not pending;  1 = pending
   35 00000000         ;             write:  0 = no effect;
   36 00000000         ;                     1 = change status to not pending
   37 00000000         ;22:PIT IRQ pending status
   38 00000000         ;12:UART0 IRQ pending status
   39 00000000 00400000 
                       NVIC_ICPR_PIT_MASK



ARM Macro Assembler    Page 2 Serial I/O Driver


                               EQU              PIT_IRQ_MASK
   40 00000000 00001000 
                       NVIC_ICPR_UART0_MASK
                               EQU              UART0_IRQ_MASK
   41 00000000         ;---------------------------------------------------------------
   42 00000000         ;NVIC_IPR0-NVIC_IPR7
   43 00000000         ;2-bit priority:  00 = highest; 11 = lowest
   44 00000000         ;--PIT
   45 00000000 00000000 
                       PIT_IRQ_PRIORITY
                               EQU              0
   46 00000000 00C00000 
                       NVIC_IPR_PIT_MASK
                               EQU              (3 << PIT_PRI_POS)
   47 00000000 00000000 
                       NVIC_IPR_PIT_PRI_0
                               EQU              (PIT_IRQ_PRIORITY << UART0_PRI_POS)
   48 00000000         ;--UART0
   49 00000000 00000003 
                       UART0_IRQ_PRIORITY
                               EQU              3
   50 00000000 000000C0 
                       NVIC_IPR_UART0_MASK
                               EQU              (3 << UART0_PRI_POS)
   51 00000000 000000C0 
                       NVIC_IPR_UART0_PRI_3
                               EQU              (UART0_IRQ_PRIORITY << UART0_PRI_POS)
   52 00000000         ;---------------------------------------------------------------
   53 00000000         ;NVIC_ISER
   54 00000000         ;31-00:SETENA=masks for HW IRQ sources;
   55 00000000         ;             read:   0 = masked;     1 = unmasked
   56 00000000         ;             write:  0 = no effect;  1 = unmask
   57 00000000         ;22:PIT IRQ mask
   58 00000000         ;12:UART0 IRQ mask
   59 00000000 00400000 
                       NVIC_ISER_PIT_MASK
                               EQU              PIT_IRQ_MASK
   60 00000000 00001000 
                       NVIC_ISER_UART0_MASK
                               EQU              UART0_IRQ_MASK
   61 00000000         ;---------------------------------------------------------------
   62 00000000         ;PIT_LDVALn:  PIT load value register n



ARM Macro Assembler    Page 3 Serial I/O Driver


   63 00000000         ;31-00:TSV=timer start value (period in clock cycles - 1)
   64 00000000         ;Clock ticks for 0.01 s at 24 MHz count rate
   65 00000000         ;0.01 s * 24,000,000 Hz = 240,000
   66 00000000         ;TSV = 240,000 - 1
   67 00000000 0003A97F 
                       PIT_LDVAL_10ms
                               EQU              239999
   68 00000000         ;---------------------------------------------------------------
   69 00000000         ;PIT_MCR:  PIT module control register
   70 00000000         ;1-->    0:FRZ=freeze (continue'/stop in debug mode)
   71 00000000         ;0-->    1:MDIS=module disable (PIT section)
   72 00000000         ;               RTI timer not affected
   73 00000000         ;               must be enabled before any other PIT setup
   74 00000000 00000001 
                       PIT_MCR_EN_FRZ
                               EQU              PIT_MCR_FRZ_MASK
   75 00000000         ;---------------------------------------------------------------
   76 00000000         ;PIT_TCTRLn:  PIT timer control register n
   77 00000000         ;0-->   2:CHN=chain mode (enable)
   78 00000000         ;1-->   1:TIE=timer interrupt enable
   79 00000000         ;1-->   0:TEN=timer enable
   80 00000000 00000003 
                       PIT_TCTRL_CH_IE
                               EQU              (PIT_TCTRL_TEN_MASK :OR: PIT_TCTRL_TIE_MASK)
   81 00000000         ;---------------------------------------------------------------
   82 00000000         ;PORTx_PCRn (Port x pin control register n [for pin n])
   83 00000000         ;___->10-08:Pin mux control (select 0 to 8)
   84 00000000         ;Use provided PORT_PCR_MUX_SELECT_2_MASK
   85 00000000         ;---------------------------------------------------------------
   86 00000000         ;Port A
   88 00000000 01000200 
                       PORT_PCR_SET_PTA1_UART0_RX
                               EQU              (PORT_PCR_ISF_MASK :OR:                                    PORT_PCR_MUX
_SELECT_2_MASK)
   90 00000000 01000200 
                       PORT_PCR_SET_PTA2_UART0_TX
                               EQU              (PORT_PCR_ISF_MASK :OR:                                    PORT_PCR_MUX
_SELECT_2_MASK)
   91 00000000         ;---------------------------------------------------------------
   92 00000000         ;SIM_SCGC4
   93 00000000         ;1->10:UART0 clock gate control (enabled)
   94 00000000         ;Use provided SIM_SCGC4_UART0_MASK



ARM Macro Assembler    Page 4 Serial I/O Driver


   95 00000000         ;---------------------------------------------------------------
   96 00000000         ;SIM_SCGC5
   97 00000000         ;1->09:Port A clock gate control (enabled)
   98 00000000         ;Use provided SIM_SCGC5_PORTA_MASK
   99 00000000         ;---------------------------------------------------------------
  100 00000000         ;SIM_SOPT2
  101 00000000         ;01=27-26:UART0SRC=UART0 clock source select
  102 00000000         ;         (PLLFLLSEL determines MCGFLLCLK' or MCGPLLCLK/2)
  103 00000000         ; 1=   16:PLLFLLSEL=PLL/FLL clock select (MCGPLLCLK/2)
  105 00000000 04000000 
                       SIM_SOPT2_UART0SRC_MCGPLLCLK
                               EQU              (1 << SIM_SOPT2_UART0SRC_SHIFT)
  107 00000000 04010000 
                       SIM_SOPT2_UART0_MCGPLLCLK_DIV2
                               EQU              (SIM_SOPT2_UART0SRC_MCGPLLCLK :OR: SIM_SOPT2_PLLFLLSEL_MASK)
  108 00000000         ;---------------------------------------------------------------
  109 00000000         ;SIM_SOPT5
  110 00000000         ; 0->   16:UART0 open drain enable (disabled)
  111 00000000         ; 0->   02:UART0 receive data select (UART0_RX)
  112 00000000         ;00->01-00:UART0 transmit data select source (UART0_TX)
  116 00000000 00010007 
                       SIM_SOPT5_UART0_EXTERN_MASK_CLEAR
                               EQU              (SIM_SOPT5_UART0ODE_MASK :OR:                                  SIM_SOPT
5_UART0RXSRC_MASK :OR:                                  SIM_SOPT5_UART0TXSRC_MASK)
  117 00000000         ;---------------------------------------------------------------
  118 00000000         ;UART0_BDH
  119 00000000         ;    0->  7:LIN break detect IE (disabled)
  120 00000000         ;    0->  6:RxD input active edge IE (disabled)
  121 00000000         ;    0->  5:Stop bit number select (1)
  122 00000000         ;00001->4-0:SBR[12:0] (UART0CLK / [9600 * (OSR + 1)]) 
  123 00000000         ;UART0CLK is MCGPLLCLK/2
  124 00000000         ;MCGPLLCLK is 96 MHz
  125 00000000         ;MCGPLLCLK/2 is 48 MHz
  126 00000000         ;SBR = 48 MHz / (9600 * 16) = 312.5 --> 312 = 0x138
  127 00000000 00000001 
                       UART0_BDH_9600
                               EQU              0x01
  128 00000000         ;---------------------------------------------------------------
  129 00000000         ;UART0_BDL
  130 00000000         ;26->7-0:SBR[7:0] (UART0CLK / [9600 * (OSR + 1)])
  131 00000000         ;UART0CLK is MCGPLLCLK/2
  132 00000000         ;MCGPLLCLK is 96 MHz



ARM Macro Assembler    Page 5 Serial I/O Driver


  133 00000000         ;MCGPLLCLK/2 is 48 MHz
  134 00000000         ;SBR = 48 MHz / (9600 * 16) = 312.5 --> 312 = 0x138
  135 00000000 00000038 
                       UART0_BDL_9600
                               EQU              0x38
  136 00000000         ;---------------------------------------------------------------
  137 00000000         ;UART0_C1
  138 00000000         ;0-->7:LOOPS=loops select (normal)
  139 00000000         ;0-->6:DOZEEN=doze enable (disabled)
  140 00000000         ;0-->5:RSRC=receiver source select (internal--no effect LOOPS=0)
  141 00000000         ;0-->4:M=9- or 8-bit mode select 
  142 00000000         ;        (1 start, 8 data [lsb first], 1 stop)
  143 00000000         ;0-->3:WAKE=receiver wakeup method select (idle)
  144 00000000         ;0-->2:IDLE=idle line type select (idle begins after start bit)
  145 00000000         ;0-->1:PE=parity enable (disabled)
  146 00000000         ;0-->0:PT=parity type (even parity--no effect PE=0)
  147 00000000 00000000 
                       UART0_C1_8N1
                               EQU              0x00
  148 00000000         ;---------------------------------------------------------------
  149 00000000         ;UART0_C2
  150 00000000         ;0-->7:TIE=transmit IE for TDRE (disabled)
  151 00000000         ;0-->6:TCIE=transmission complete IE for TC (disabled)
  152 00000000         ;0-->5:RIE=receiver IE for RDRF (disabled)
  153 00000000         ;0-->4:ILIE=idle line IE for IDLE (disabled)
  154 00000000         ;1-->3:TE=transmitter enable (enabled)
  155 00000000         ;1-->2:RE=receiver enable (enabled)
  156 00000000         ;0-->1:RWU=receiver wakeup control (normal)
  157 00000000         ;0-->0:SBK=send break (disabled, normal)
  158 00000000 0000000C 
                       UART0_C2_T_R
                               EQU              (UART0_C2_TE_MASK :OR: UART0_C2_RE_MASK)
  159 00000000 0000002C 
                       UART0_C2_T_RI
                               EQU              (UART0_C2_RIE_MASK :OR: UART0_C2_T_R)
  160 00000000 000000AC 
                       UART0_C2_TI_RI
                               EQU              (UART0_C2_TIE_MASK :OR: UART0_C2_T_RI)
  161 00000000         ;---------------------------------------------------------------
  162 00000000         ;UART0_C3
  163 00000000         ;0-->7:R8T9=9th data bit for receiver (not used M=0)
  164 00000000         ;           10th data bit for transmitter (not used M10=0)



ARM Macro Assembler    Page 6 Serial I/O Driver


  165 00000000         ;0-->6:R9T8=9th data bit for transmitter (not used M=0)
  166 00000000         ;           10th data bit for receiver (not used M10=0)
  167 00000000         ;0-->5:TXDIR=UART_TX pin direction in single-wire mode
  168 00000000         ;            (no effect LOOPS=0)
  169 00000000         ;0-->4:TXINV=transmit data inversion (not inverted)
  170 00000000         ;0-->3:ORIE=overrun IE for OR (disabled)
  171 00000000         ;0-->2:NEIE=noise error IE for NF (disabled)
  172 00000000         ;0-->1:FEIE=framing error IE for FE (disabled)
  173 00000000         ;0-->0:PEIE=parity error IE for PF (disabled)
  174 00000000 00000000 
                       UART0_C3_NO_TXINV
                               EQU              0x00
  175 00000000         ;---------------------------------------------------------------
  176 00000000         ;UART0_C4
  177 00000000         ;    0-->  7:MAEN1=match address mode enable 1 (disabled)
  178 00000000         ;    0-->  6:MAEN2=match address mode enable 2 (disabled)
  179 00000000         ;    0-->  5:M10=10-bit mode select (not selected)
  180 00000000         ;01111-->4-0:OSR=over sampling ratio (16)
  181 00000000         ;               = 1 + OSR for 3 <= OSR <= 31
  182 00000000         ;               = 16 for 0 <= OSR <= 2 (invalid values)
  183 00000000 0000000F 
                       UART0_C4_OSR_16
                               EQU              0x0F
  184 00000000 0000000F 
                       UART0_C4_NO_MATCH_OSR_16
                               EQU              UART0_C4_OSR_16
  185 00000000         ;---------------------------------------------------------------
  186 00000000         ;UART0_C5
  187 00000000         ;  0-->  7:TDMAE=transmitter DMA enable (disabled)
  188 00000000         ;  0-->  6:Reserved; read-only; always 0
  189 00000000         ;  0-->  5:RDMAE=receiver full DMA enable (disabled)
  190 00000000         ;000-->4-2:Reserved; read-only; always 0
  191 00000000         ;  0-->  1:BOTHEDGE=both edge sampling (rising edge only)
  192 00000000         ;  0-->  0:RESYNCDIS=resynchronization disable (enabled)
  193 00000000 00000000 
                       UART0_C5_NO_DMA_SSR_SYNC
                               EQU              0x00
  194 00000000         ;---------------------------------------------------------------
  195 00000000         ;UART0_S1
  196 00000000         ;0-->7:TDRE=transmit data register empty flag; read-only
  197 00000000         ;0-->6:TC=transmission complete flag; read-only
  198 00000000         ;0-->5:RDRF=receive data register full flag; read-only



ARM Macro Assembler    Page 7 Serial I/O Driver


  199 00000000         ;1-->4:IDLE=idle line flag; write 1 to clear (clear)
  200 00000000         ;1-->3:OR=receiver overrun flag; write 1 to clear (clear)
  201 00000000         ;1-->2:NF=noise flag; write 1 to clear (clear)
  202 00000000         ;1-->1:FE=framing error flag; write 1 to clear (clear)
  203 00000000         ;1-->0:PF=parity error flag; write 1 to clear (clear)
  204 00000000 0000001F 
                       UART0_S1_CLEAR_FLAGS
                               EQU              0x1F
  205 00000000         ;---------------------------------------------------------------
  206 00000000         ;UART0_S2
  207 00000000         ;1-->7:LBKDIF=LIN break detect interrupt flag (clear)
  208 00000000         ;             write 1 to clear
  209 00000000         ;1-->6:RXEDGIF=RxD pin active edge interrupt flag (clear)
  210 00000000         ;              write 1 to clear
  211 00000000         ;0-->5:(reserved); read-only; always 0
  212 00000000         ;0-->4:RXINV=receive data inversion (disabled)
  213 00000000         ;0-->3:RWUID=receive wake-up idle detect
  214 00000000         ;0-->2:BRK13=break character generation length (10)
  215 00000000         ;0-->1:LBKDE=LIN break detect enable (disabled)
  216 00000000         ;0-->0:RAF=receiver active flag; read-only
  217 00000000 000000C0 
                       UART0_S2_NO_RXINV_BRK10_NO_LBKDETECT_CLEAR_FLAGS
                               EQU              0xC0
  218 00000000         ;---------------------------------------------------------------
  219 00000000 0000000A 
                       LF      EQU              10
  220 00000000 0000000D 
                       CR      EQU              13
  221 00000000 00000000 
                       NULL    EQU              0
  222 00000000 0000004F 
                       MAX_STRING
                               EQU              79
  223 00000000         
  224 00000000         ;Queue Operation
  225 00000000 00000000 
                       IN_PTR  EQU              0
  226 00000000 00000004 
                       OUT_PTR EQU              4
  227 00000000 00000008 
                       BUFF_START
                               EQU              8



ARM Macro Assembler    Page 8 Serial I/O Driver


  228 00000000 0000000C 
                       BUFF_PAST
                               EQU              12
  229 00000000 00000010 
                       BUFF_SIZE
                               EQU              16
  230 00000000 00000011 
                       NUM_INQUEUE
                               EQU              17
  231 00000000 00000050 
                       Tx_Rx_Q_BUF_SZ
                               EQU              80
  232 00000000 00000012 
                       Q_REC_SZ
                               EQU              18
  233 00000000         ;****************************************************************
  234 00000000         ;Program
  235 00000000         ;Linker requires Reset_Handler
  236 00000000                 AREA             MyCode,CODE,READONLY
  237 00000000                 ENTRY
  238 00000000                 EXPORT           Reset_Handler
  239 00000000                 IMPORT           Startup
  240 00000000         Reset_Handler
                               PROC             {},{}
  241 00000000         main
  242 00000000         ;---------------------------------------------------------------
  243 00000000         ;Mask interrupts
  244 00000000 B672            CPSID            I
  245 00000002         ;KL46 system startup with 48-MHz system clock
  246 00000002 F7FF FFFE       BL               Startup
  247 00000006         ;---------------------------------------------------------------
  248 00000006         ;>>>>> begin main program code <<<<<
  249 00000006 F7FF FFFE       BL               Init_UART0_IRQ ;initialize UART0 for interrupts
  250 0000000A B662            CPSIE            I           ;unmask interrupts
  251 0000000C 48D6            LDR              R0,=RunStopWatch
  252 0000000E 2100            MOVS             R1,#0
  253 00000010 7001            STRB             R1,[R0,#0]  ;RunStopWatch == 0
  254 00000012 48D6            LDR              R0,=Count
  255 00000014 6001            STR              R1,[R0,#0]  ;Count == 0
  256 00000016 F7FF FFFE       BL               Init_PIT_IRQ ;initialize PIT
  257 0000001A         
  258 0000001A 48D5            LDR              R0,=EnterName



ARM Macro Assembler    Page 9 Serial I/O Driver


  259 0000001C 214F            MOVS             R1,#MAX_STRING
  260 0000001E F7FF FFFE       BL               PutStringSB ;print name prompt
  261 00000022 F7FF FFFE       BL               GetUserInput
  262 00000026 48D3            LDR              R0,=EnterDate
  263 00000028 F7FF FFFE       BL               PutStringSB ;print date prompt
  264 0000002C F7FF FFFE       BL               GetUserInput
  265 00000030 48D1            LDR              R0,=EnterTA
  266 00000032 F7FF FFFE       BL               PutStringSB ;print TA prompt
  267 00000036 F7FF FFFE       BL               GetUserInput
  268 0000003A 48D0            LDR              R0,=GoodBye
  269 0000003C F7FF FFFE       BL               PutStringSB ;goodbye!
  270 00000040         ;>>>>>   end main program code <<<<<
  271 00000040         ;Stay here
  272 00000040 E7FE            B                .
  273 00000042                 ENDP
  274 00000042         ;>>>>> begin subroutine code <<<<<
  275 00000042         GetUserInput
                               PROC             {R0-R14},{}
  276 00000042         ;------------------------------------
  277 00000042         ;gets user input and times how long it takes
  278 00000042         ;inputs; none
  279 00000042         ;outputs; none
  280 00000042         ;------------------------------------
  281 00000042 B507            PUSH             {R0-R2,LR}
  282 00000044 48C9            LDR              R0,=Count
  283 00000046 2200            MOVS             R2,#0
  284 00000048 6002            STR              R2,[R0,#0]  ;count == 0
  285 0000004A 48C7            LDR              R0,=RunStopWatch
  286 0000004C 2101            MOVS             R1,#1
  287 0000004E 7001            STRB             R1,[R0,#0]  ;begin timing (RunStopWatch == 1)
  288 00000050 F7FF FFFE       BL               GetStringSB ;get user input
  289 00000054 7002            STRB             R2,[R0,#0]  ;end timing   (RunStopWatch == 0)
  290 00000056         
  291 00000056 203C            MOVS             R0,#'<'
  292 00000058 F7FF FFFE       BL               PutChar
  293 0000005C 48C3            LDR              R0,=Count
  294 0000005E 6800            LDR              R0,[R0,#0]
  295 00000060 F7FF FFFE       BL               PutNumU
  296 00000064 48C6            LDR              R0,=TimeReturn
  297 00000066 214F            MOVS             R1,#MAX_STRING
  298 00000068 F7FF FFFE       BL               PutStringSB ;print time elapsed
  299 0000006C BD07            POP              {R0-R2,PC}



ARM Macro Assembler    Page 10 Serial I/O Driver


  300 0000006E                 ENDP
  301 0000006E         
  302 0000006E         PIT_ISR PROC             {R0-R14},{}
  303 0000006E         ;------------------------------------
  304 0000006E         ;Handles PIT interrupts.
  305 0000006E         ;R0,R1 handled by ISR mechanics; no need to push.
  306 0000006E         ;------------------------------------
  307 0000006E B672            CPSID            I
  308 00000070 48BD            LDR              R0,=RunStopWatch
  309 00000072 2800            CMP              R0,#0       ;if RunStopWatch != 0
  310 00000074 D003            BEQ              EndPIT_ISR  ;else go to end of ISR
  311 00000076 48BD            LDR              R0,=Count
  312 00000078 6801            LDR              R1,[R0,#0]
  313 0000007A 1C49            ADDS             R1,R1,#1
  314 0000007C 6001            STR              R1,[R0,#0]  ;increment count
  315 0000007E         EndPIT_ISR
  316 0000007E 48C6            LDR              R0,=PIT_CH0_BASE
  317 00000080 49C6            LDR              R1,=PIT_TFLG_TIF_MASK
  318 00000082 60C1            STR              R1,[R0,#PIT_TFLG_OFFSET] ;clear interrupt
  319 00000084         
  320 00000084 B662            CPSIE            I
  321 00000086 4770            BX               LR
  322 00000088                 ENDP
  323 00000088         
  324 00000088         Init_PIT_IRQ
                               PROC             {R0-R14},{}
  325 00000088         ;------------------------------------
  326 00000088         ;Initializes PIT to generate interrupts
  327 00000088         ;every .01s from channel 0.
  328 00000088         ;No inputs. No outputs.
  329 00000088         ;Leaves all registers unchanged.
  330 00000088         ;------------------------------------
  331 00000088 B407            PUSH             {R0-R2}
  332 0000008A         ; -- Enable PIT Module Clock
  333 0000008A 49C5            LDR              R1,=SIM_SCGC6
  334 0000008C 4AC5            LDR              R2,=SIM_SCGC6_PIT_MASK
  335 0000008E 6808            LDR              R0,[R1,#0]
  336 00000090 4310            ORRS             R0,R0,R2
  337 00000092 6008            STR              R0,[R1,#0]
  338 00000094         
  339 00000094         ; -- Disable PIT Timer 0
  340 00000094 48C0            LDR              R0,=PIT_CH0_BASE



ARM Macro Assembler    Page 11 Serial I/O Driver


  341 00000096 49C1            LDR              R1,=PIT_TCTRL_TEN_MASK
  342 00000098 6882            LDR              R2,[R0,#PIT_TCTRL_OFFSET]
  343 0000009A 438A            BICS             R2,R2,R1
  344 0000009C 6082            STR              R2,[R0,#PIT_TCTRL_OFFSET]
  345 0000009E         
  346 0000009E         ; -- Set PIT interrupt priority
  347 0000009E 48C2            LDR              R0,=PIT_IPR
  348 000000A0 49C2            LDR              R1,=NVIC_IPR_PIT_MASK
  349 000000A2 6802            LDR              R2,[R0,#0]
  350 000000A4 438A            BICS             R2,R2,R1
  351 000000A6 6002            STR              R2,[R0,#0]
  352 000000A8         
  353 000000A8         ; -- Clear pending PIT interrupts
  354 000000A8 48C1            LDR              R0,=NVIC_ICPR
  355 000000AA 49C2            LDR              R1,=NVIC_ICPR_PIT_MASK
  356 000000AC 6001            STR              R1,[R0,#0]
  357 000000AE         
  358 000000AE         ; -- Unmask PIT interrupts
  359 000000AE 48C2            LDR              R0,=NVIC_ISER
  360 000000B0 49C0            LDR              R1,=PIT_IRQ_MASK
  361 000000B2 6001            STR              R1,[R0,#0]
  362 000000B4         
  363 000000B4         ; -- Enable PIT Module
  364 000000B4 48C1            LDR              R0,=PIT_BASE
  365 000000B6 49B9            LDR              R1,=PIT_MCR_EN_FRZ
  366 000000B8 6001            STR              R1,[R0,#PIT_MCR_OFFSET]
  367 000000BA         
  368 000000BA         ; -- Set Timer 0 period
  369 000000BA 48B7            LDR              R0,=PIT_CH0_BASE
  370 000000BC 49C0            LDR              R1,=PIT_LDVAL_10ms
  371 000000BE 6001            STR              R1,[R0,#PIT_LDVAL_OFFSET]
  372 000000C0         
  373 000000C0         ; -- Enable PIT Timer 0 with interrupts
  374 000000C0 48B5            LDR              R0,=PIT_CH0_BASE
  375 000000C2 2103            MOVS             R1,#PIT_TCTRL_CH_IE
  376 000000C4 6081            STR              R1,[R0,#PIT_TCTRL_OFFSET]
  377 000000C6         
  378 000000C6 BC07            POP              {R0-R2}
  379 000000C8 4770            BX               LR
  380 000000CA                 ENDP
  381 000000CA         
  382 000000CA         GetChar PROC             {R1-R14},{}



ARM Macro Assembler    Page 12 Serial I/O Driver


  383 000000CA         ;------------------------------------
  384 000000CA         ;Loads character data from UART0 into R0
  385 000000CA         ;Input; none
  386 000000CA         ;Output; R0
  387 000000CA         ;Changed Registers; R0
  388 000000CA         ;------------------------------------
  389 000000CA B502            PUSH             {R1,LR}
  390 000000CC         GetCharLoop
  391 000000CC 49AD            LDR              R1,=RxQRecord ;critical code:
  392 000000CE B672            CPSID            I           ;mask interrupts
  393 000000D0 F7FF FFFE       BL               Dequeue     ;attempt to dequeue
  394 000000D4 B662            CPSIE            I           ;unmask interrupts
  395 000000D6 D2F9            BCS              GetCharLoop ;if dequeue failed,
  396 000000D8         ;loop, wait until char
  397 000000D8 BD02            POP              {R1,PC}
  398 000000DA                 ENDP
  399 000000DA         
  400 000000DA         PutChar PROC             {R0-R14},{}
  401 000000DA         ;------------------------------------
  402 000000DA         ;Stores character data from R0 into the data of
  403 000000DA         ;UART0.
  404 000000DA         ;Input; R0
  405 000000DA         ;Output; none
  406 000000DA         ;Changed registers; none
  407 000000DA         ;------------------------------------
  408 000000DA B506            PUSH             {R1-R2,LR}
  409 000000DC         PutCharLoop
  410 000000DC 49AA            LDR              R1,=TxQRecord ;critical code:
  411 000000DE B672            CPSID            I           ;mask interrupts
  412 000000E0 F7FF FFFE       BL               Enqueue     ;attempt to enqueue
  413 000000E4 B662            CPSIE            I           ;unmask interrupts
  414 000000E6 D2F9            BCS              PutCharLoop ;if enqueue failed,
  415 000000E8         ;loop, wait until enqueue
  416 000000E8 4AB8            LDR              R2,=UART0_BASE
  417 000000EA 21AC            MOVS             R1,#UART0_C2_TI_RI
  418 000000EC 70D1            STRB             R1,[R2,#UART0_C2_OFFSET] ;enable transmit interrupts
  419 000000EE BD06            POP              {R1-R2,PC}
  420 000000F0                 ENDP
  421 000000F0         
  422 000000F0         UART0_ISR
                               PROC             {R0-R14},{}
  423 000000F0         ;------------------------------------



ARM Macro Assembler    Page 13 Serial I/O Driver


  424 000000F0         ; Handles UART0 Interrupts.
  425 000000F0         ;------------------------------------
  426 000000F0 B500            PUSH             {LR}
  427 000000F2 B672            CPSID            I           ;mask interrupts
  428 000000F4 49B5            LDR              R1,=UART0_BASE
  429 000000F6 2280            MOVS             R2,#UART0_C2_TIE_MASK
  430 000000F8 78CB            LDRB             R3,[R1,#UART0_C2_OFFSET]
  431 000000FA 4213            TST              R3,R2
  432 000000FC D00E            BEQ              RxHandling  ;if not(TIE) then go to Rx
  433 000000FE         TxHandling
  434 000000FE 2280            MOVS             R2,#UART0_S1_TDRE_MASK
  435 00000100 790B            LDRB             R3,[R1,#UART0_S1_OFFSET]
  436 00000102 4213            TST              R3,R2
  437 00000104 D00A            BEQ              RxHandling  ;if not(Tx) branch
  438 00000106 49A0            LDR              R1,=TxQRecord
  439 00000108 F7FF FFFE       BL               Dequeue     ;get character from TxQueue
  440 0000010C D202            BCS              TxDisableInterrupts ;dequeue success
  441 0000010E 49AF            LDR              R1,=UART0_BASE ;store to UART0
  442 00000110 71C8            STRB             R0,[R1,#UART0_D_OFFSET]
  443 00000112 E008            B                EndUART0_ISR
  444 00000114         TxDisableInterrupts
  445 00000114 48AD            LDR              R0,=UART0_BASE ;dequeue failure; no characters to transmit
  446 00000116 212C            MOVS             R1,#UART0_C2_T_RI ;disable Txinterrupts
  447 00000118 70C1            STRB             R1,[R0,#UART0_C2_OFFSET]
  448 0000011A E004            B                EndUART0_ISR
  449 0000011C         RxHandling
  450 0000011C 49AB            LDR              R1,=UART0_BASE
  451 0000011E 79C8            LDRB             R0,[R1,#UART0_D_OFFSET] ;load character from UART0
  452 00000120 4998            LDR              R1,=RxQRecord
  453 00000122 F7FF FFFE       BL               Enqueue     ;enqueue it into RxRecord
  454 00000126         EndUART0_ISR
  455 00000126 B662            CPSIE            I           ;unmask interrupts
  456 00000128 BD00            POP              {PC}
  457 0000012A                 ENDP
  458 0000012A         
  459 0000012A         Init_UART0_IRQ
                               PROC             {R0-R14},{}
  460 0000012A         ;------------------------------------
  461 0000012A         ;Initializes UART0 for interrupts.
  462 0000012A         ;Takes no input
  463 0000012A         ;Gives no output
  464 0000012A         ;Modifies no registers permanently



ARM Macro Assembler    Page 14 Serial I/O Driver


  465 0000012A         ;------------------------------------
  466 0000012A B50F            PUSH{R0-R3,LR}
  467 0000012C         ;-- Initialize TxQ/RxQ
  468 0000012C 4897            LDR              R0,=TxQ
  469 0000012E 4996            LDR              R1,=TxQRecord
  470 00000130 4AAB            LDR              R2,=Tx_Rx_Q_BUF_SZ
  471 00000132 F7FF FFFE       BL               InitQueue   ;initialize TxQ
  472 00000136         
  473 00000136 4896            LDR              R0,=RxQ
  474 00000138 4992            LDR              R1,=RxQRecord
  475 0000013A 4AA9            LDR              R2,=Tx_Rx_Q_BUF_SZ
  476 0000013C F7FF FFFE       BL               InitQueue   ;initializes RxQ
  477 00000140         
  478 00000140         ;-- Set SIM_SOPT2 for UART0 PLL CLK / 2
  479 00000140 48AA            LDR              R0,=SIM_SOPT2
  480 00000142 49AB            LDR              R1,=SIM_SOPT2_UART0SRC_MASK
  481 00000144 6802            LDR              R2,[R0,#0]  ;current SIM_SOPT2
  482 00000146 438A            BICS             R2,R2,R1    ;only clears UART0SRC bits
  483 00000148 49AA            LDR              R1,=SIM_SOPT2_UART0_MCGPLLCLK_DIV2
  484 0000014A 430A            ORRS             R2,R2,R1    ;only changes UART0 bits
  485 0000014C 6002            STR              R2,[R0,#0]  ;update SIM_SOPT2
  486 0000014E         ;-- Same as in Polling
  487 0000014E         
  488 0000014E         ;-- Set SIM_SOPT5 for UART0 External
  489 0000014E 48AA            LDR              R0,=SIM_SOPT5
  490 00000150 49AA            LDR              R1,=SIM_SOPT5_UART0_EXTERN_MASK_CLEAR
  491 00000152 6802            LDR              R2,[R0,#0]  ;current SIM_SOPT5
  492 00000154 438A            BICS             R2,R2,R1    ;only UARTO Bits cleared
  493 00000156 6002            STR              R2,[R0,#0]  ;store SIM_SOPT5
  494 00000158         ;-- Same as in Polling
  495 00000158         
  496 00000158         ;-- Set SIM_SCGC4 for UART0 CLOCK ENABLED
  497 00000158 48A9            LDR              R0,=SIM_SCGC4
  498 0000015A 49AA            LDR              R1,=SIM_SCGC4_UART0_MASK
  499 0000015C 6802            LDR              R2,[R0,#0]  ;current SIM_SCGC4
  500 0000015E 430A            ORRS             R2,R2,R1    ;only uart bits set
  501 00000160 6002            STR              R2,[R0,#0]  ;store SIM_SCGC4
  502 00000162         ;-- Same as in Polling
  503 00000162         
  504 00000162         ;-- Set SIM_CGC5 for Port A Clock Enabled
  505 00000162 48A9            LDR              R0,=SIM_SCGC5
  506 00000164 49A9            LDR              R1,=SIM_SCGC5_PORTA_MASK



ARM Macro Assembler    Page 15 Serial I/O Driver


  507 00000166 6802            LDR              R2,[R0,#0]  ;current SIM-SCGC5
  508 00000168 430A            ORRS             R2,R2,R1    ;only PORTA bit set
  509 0000016A 6002            STR              R2,[R0,#0]  ;update SIM_SCGC5
  510 0000016C         ;-- Same as in Polling
  511 0000016C         
  512 0000016C         ;-- Set Pins for UART0 Rx and Tx
  513 0000016C 48A8            LDR              R0,=PORTA_PCR1
  514 0000016E 49A9            LDR              R1,=PORT_PCR_SET_PTA1_UART0_RX
  515 00000170 6001            STR              R1,[R0,#0]
  516 00000172 48A9            LDR              R0,=PORTA_PCR2
  517 00000174 49A7            LDR              R1,=PORT_PCR_SET_PTA2_UART0_TX
  518 00000176 6001            STR              R1,[R0,#0]
  519 00000178         ;-- Same as in Polling
  520 00000178         
  521 00000178         ;-- Disable UART0
  522 00000178 4894            LDR              R0,=UART0_BASE
  523 0000017A 210C            MOVS             R1,#UART0_C2_T_R
  524 0000017C 78C2            LDRB             R2,[R0,#UART0_C2_OFFSET]
  525 0000017E 438A            BICS             R2,R2,R1
  526 00000180 70C2            STRB             R2,[R0,#UART0_C2_OFFSET]
  527 00000182         ;-- Same as in Polling
  528 00000182         
  529 00000182         ;-- initialization
  530 00000182         
  531 00000182         ;-- Initialize NVIC for UART0 Interrupts
  532 00000182 48A6            LDR              R0,=UART0_IPR
  533 00000184 22C0            MOVS             R2,#NVIC_IPR_UART0_PRI_3
  534 00000186 6803            LDR              R3,[R0,#0]
  535 00000188 4313            ORRS             R3,R3,R2
  536 0000018A 6003            STR              R3,[R0,#0]
  537 0000018C         
  538 0000018C         ;-- Clear all pending interrupts
  539 0000018C 4888            LDR              R0,=NVIC_ICPR
  540 0000018E 49A4            LDR              R1,=NVIC_ICPR_UART0_MASK
  541 00000190 6001            STR              R1,[R0,#0]
  542 00000192         
  543 00000192         ;-- Unmask UART0 Interrupts
  544 00000192 4889            LDR              R0,=NVIC_ISER
  545 00000194 49A2            LDR              R1,=NVIC_ISER_UART0_MASK
  546 00000196 6001            STR              R1,[R0,#0]
  547 00000198         
  548 00000198         ;-- set UART0 baud rate



ARM Macro Assembler    Page 16 Serial I/O Driver


  549 00000198 488C            LDR              R0,=UART0_BASE
  550 0000019A 2101            MOVS             R1,#UART0_BDH_9600
  551 0000019C 7001            STRB             R1,[R0,#UART0_BDH_OFFSET]
  552 0000019E 2138            MOVS             R1,#UART0_BDL_9600
  553 000001A0 7041            STRB             R1,[R0,#UART0_BDL_OFFSET]
  554 000001A2         
  555 000001A2         ;-- set UART0 character format
  556 000001A2 2100            MOVS             R1,#UART0_C1_8N1
  557 000001A4 7081            STRB             R1,[R0,#UART0_C1_OFFSET]
  558 000001A6 2100            MOVS             R1,#UART0_C3_NO_TXINV
  559 000001A8 7181            STRB             R1,[R0,#UART0_C3_OFFSET]
  560 000001AA 210F            MOVS             R1,#UART0_C4_NO_MATCH_OSR_16
  561 000001AC 7281            STRB             R1,[R0,#UART0_C4_OFFSET]
  562 000001AE 2100            MOVS             R1,#UART0_C5_NO_DMA_SSR_SYNC
  563 000001B0 72C1            STRB             R1,[R0,#UART0_C5_OFFSET]
  564 000001B2 211F            MOVS             R1,#UART0_S1_CLEAR_FLAGS
  565 000001B4 7101            STRB             R1,[R0,#UART0_S1_OFFSET]
  566 000001B6 21C0            MOVS             R1,#UART0_S2_NO_RXINV_BRK10_NO_LBKDETECT_CLEAR_FLAGS
  567 000001B8 7141            STRB             R1,[R0,#UART0_S2_OFFSET]
  568 000001BA         
  569 000001BA         ;-- enable UART0 Transmitter, Reciever, and Recieve interrupt.
  570 000001BA 212C            MOVS             R1,#UART0_C2_T_RI
  571 000001BC 70C1            STRB             R1,[R0,#UART0_C2_OFFSET]
  572 000001BE         
  573 000001BE BD0F            POP{R0-R3,PC}
  574 000001C0                 ENDP
  575 000001C0         
  576 000001C0         InitQueue
                               PROC             {R0-R14},{}
  577 000001C0         ;-------------------
  578 000001C0         ; Initializes a queue.
  579 000001C0         ; Input: R0; queue buffer address
  580 000001C0         ; Input: R1; queue record address
  581 000001C0         ; Input: R2; queue buffer size
  582 000001C0         ;-------------------
  583 000001C0 B407            PUSH             {R0-R2}
  584 000001C2 6008            STR              R0,[R1,#IN_PTR]
  585 000001C4 6048            STR              R0,[R1,#OUT_PTR]
  586 000001C6 6088            STR              R0,[R1,#BUFF_START] ;the in pointer, out pointer, and start of the buffe
                                                            r are all the same for a new queue
  587 000001C8 1880            ADDS             R0,R0,R2
  588 000001CA 60C8            STR              R0,[R1,#BUFF_PAST] ;the end of the queue is the number of items after th



ARM Macro Assembler    Page 17 Serial I/O Driver


                                                            e start of the queue (for item size 1)
  589 000001CC 740A            STRB             R2,[R1,#BUFF_SIZE]
  590 000001CE 2000            MOVS             R0,#0
  591 000001D0 7448            STRB             R0,[R1,#NUM_INQUEUE] ;a new queue has no items stored
  592 000001D2 BC07            POP              {R0-R2}
  593 000001D4 4770            BX               LR
  594 000001D6                 ENDP
  595 000001D6         
  596 000001D6         Enqueue PROC             {R0-R14},{}
  597 000001D6         ;-----------------------
  598 000001D6         ; Attempts to put a character in queue; returns C flag set if failure
  599 000001D6         ; Input: R0; character to enqueue
  600 000001D6         ; Input: R1; queue record address 
  601 000001D6         ; Output: C flag
  602 000001D6         ;-----------------------
  603 000001D6 B40F            PUSH             {R0-R3}
  604 000001D8 7C4A            LDRB             R2,[R1,#NUM_INQUEUE] ;compares number in queue
  605 000001DA 7C0B            LDRB             R3,[R1,#BUFF_SIZE] ;to maximum queue size 
  606 000001DC 429A            CMP              R2,R3       ;if queue is full, branch and return failure
  607 000001DE D20C            BHS              EnqueueFailed
  608 000001E0         
  609 000001E0 680B            LDR              R3,[R1,#IN_PTR]
  610 000001E2 7018            STRB             R0,[R3,#0]  ;store R0 at the in-pointer of queue
  611 000001E4 1C52            ADDS             R2,R2,#1
  612 000001E6 744A            STRB             R2,[R1,#NUM_INQUEUE] 
                                                            ;increment and store the number of elements in queue
  613 000001E8 1C5B            ADDS             R3,R3,#1    ;increment in-pointer of queue
  614 000001EA 68CA            LDR              R2,[R1,#BUFF_PAST]
  615 000001EC 4293            CMP              R3,R2       ;check if R3 is in range
  616 000001EE D201            BHS              EnqueueCircular ;if not, loop around
  617 000001F0         
  618 000001F0 600B            STR              R3,[R1,#IN_PTR] ;if it is in range; store it
  619 000001F2 E00A            B                EnqueueSuccess
  620 000001F4         
  621 000001F4         EnqueueCircular
  622 000001F4 688B            LDR              R3,[R1,#BUFF_START] ;load into R3 the first address in buffer
  623 000001F6 600B            STR              R3,[R1,#IN_PTR] ;and store it as inpointer
  624 000001F8 E007            B                EnqueueSuccess
  625 000001FA         
  626 000001FA         EnqueueFailed
  627 000001FA F3EF 8000       MRS              R0,APSR
  628 000001FE 2120            MOVS             R1,#0x20



ARM Macro Assembler    Page 18 Serial I/O Driver


  629 00000200 0609            LSLS             R1,R1,#24
  630 00000202 4308            ORRS             R0,R0,R1
  631 00000204 F380 8800       MSR              APSR,R0     ;set C flag
  632 00000208 E007            B                EndEnqueue
  633 0000020A         
  634 0000020A         EnqueueSuccess
  635 0000020A F3EF 8000       MRS              R0,APSR
  636 0000020E 2120            MOVS             R1,#0x20
  637 00000210 0609            LSLS             R1,R1,#24
  638 00000212 4388            BICS             R0,R0,R1
  639 00000214 F380 8800       MSR              APSR,R0     ;clear C flag
  640 00000218 E7FF            B                EndEnqueue
  641 0000021A         
  642 0000021A         EndEnqueue
  643 0000021A BC0F            POP              {R0-R3}
  644 0000021C 4770            BX               LR
  645 0000021E                 ENDP
  646 0000021E         
  647 0000021E         Dequeue PROC             {R1-R14},{}
  648 0000021E         ;-----------------------
  649 0000021E         ; Attempts to get a character from the queue; sets C flag to indicate failure
  650 0000021E         ; Input: R1; queue record address
  651 0000021E         ; Output: R0; dequeued character 
  652 0000021E         ; Output: C flag
  653 0000021E         ;-----------------------
  654 0000021E B40E            PUSH             {R1-R3}
  655 00000220 7C4A            LDRB             R2,[R1,#NUM_INQUEUE] ;loads the number of items in the queue
  656 00000222 2A00            CMP              R2,#0       ;you can't dequeue if there are no items
  657 00000224 D00C            BEQ              DequeueFailed ;so branch to failure
  658 00000226         
  659 00000226 684B            LDR              R3,[R1,#OUT_PTR] ;otherwise, load the address of the out pointer
  660 00000228 7818            LDRB             R0,[R3,#0]  ;then load the byte at that pointer
  661 0000022A 1E52            SUBS             R2,R2,#1    ;decrement the number of items in the queue
  662 0000022C 744A            STRB             R2,[R1,#NUM_INQUEUE] ;and store again
  663 0000022E 1C5B            ADDS             R3,R3,#1    ;Add 1 to the out pointer's address
  664 00000230 68CA            LDR              R2,[R1,#BUFF_PAST]
  665 00000232 4293            CMP              R3,R2       ;check if the out pointer is outside the queue
  666 00000234 D201            BHS              DequeueCircular ;if so, circle around
  667 00000236         
  668 00000236 604B            STR              R3,[R1,#OUT_PTR] ;else just store R3
  669 00000238 E00A            B                DequeueSuccess ;branch to success
  670 0000023A         



ARM Macro Assembler    Page 19 Serial I/O Driver


  671 0000023A         DequeueCircular
  672 0000023A 688B            LDR              R3,[R1,#BUFF_START] ;load into R3 the first address in buffer
  673 0000023C 604B            STR              R3,[R1,#OUT_PTR] ;and store it as outpointer
  674 0000023E E007            B                DequeueSuccess ;branch to success
  675 00000240         
  676 00000240         DequeueFailed
  677 00000240 F3EF 8200       MRS              R2,APSR
  678 00000244 2120            MOVS             R1,#0x20
  679 00000246 0609            LSLS             R1,R1,#24
  680 00000248 430A            ORRS             R2,R2,R1
  681 0000024A F382 8800       MSR              APSR,R2     ;set C flag
  682 0000024E E007            B                EndDequeue
  683 00000250         
  684 00000250         DequeueSuccess
  685 00000250 F3EF 8200       MRS              R2,APSR
  686 00000254 2120            MOVS             R1,#0x20
  687 00000256 0609            LSLS             R1,R1,#24
  688 00000258 438A            BICS             R2,R2,R1
  689 0000025A F382 8800       MSR              APSR,R2     ;clear C flag
  690 0000025E E7FF            B                EndDequeue
  691 00000260         
  692 00000260         EndDequeue
  693 00000260 BC0E            POP              {R1-R3}
  694 00000262 4770            BX               LR
  695 00000264                 ENDP
  696 00000264         
  697 00000264         
  698 00000264         GetStringSB
                               PROC             {R0-R14},{}
  699 00000264         ;---------------------------
  700 00000264         ; Reads a string from terminal keyboard until enter is pressed,
  701 00000264         ; and stores it in memory at R0.
  702 00000264         ; Does not allow more than Max_String characters.
  703 00000264         ; Input: R0- Memory location to store string.
  704 00000264         ; Uses: GetChar, PutChar
  705 00000264         ;---------------------------
  706 00000264 B507            PUSH             {R0-R2,LR}
  707 00000266 0002            MOVS             R2,R0       ;moves the memory address R0 into R2
  708 00000268 1E49            SUBS             R1,R1,#1    ;R1 <- MaxString-1 characters
  709 0000026A         GetStringLoop
  710 0000026A         
  711 0000026A F7FF FFFE       BL               GetChar     ;gets a character into R0



ARM Macro Assembler    Page 20 Serial I/O Driver


  712 0000026E 280D            CMP              R0,#0xD
  713 00000270 D00A            BEQ              EndGetString ;branches on character return
  714 00000272 F7FF FFFE       BL               PutChar
  715 00000276 7010            STRB             R0,[R2,#0]  ;stores the character at R0 into R2
  716 00000278 1C52            ADDS             R2,R2,#1    ;increments the memory location at R2
  717 0000027A 1E49            SUBS             R1,R1,#1    ;subtracts 1 from the string length
  718 0000027C D1F5            BNE              GetStringLoop ;if you still have characters left; (R1!=0), continue.
  719 0000027E         
  720 0000027E         OverflowLoop
  721 0000027E F7FF FFFE       BL               GetChar     ;gets a character into R0
  722 00000282 280D            CMP              R0,#0xD
  723 00000284 D000            BEQ              EndGetString ;end string on Carriage Return
  724 00000286 E7FA            B                OverflowLoop ;stay here until branch to end of string
  725 00000288         
  726 00000288         EndGetString
  727 00000288 2000            MOVS             R0,#0
  728 0000028A 7010            STRB             R0,[R2,#0]  ;null terminates string
  729 0000028C 200A            MOVS             R0,#LF      ;line feeds to next line
  730 0000028E F7FF FFFE       BL               PutChar
  731 00000292 200D            MOVS             R0,#CR      ;returns cursor to start of line
  732 00000294 F7FF FFFE       BL               PutChar
  733 00000298         
  734 00000298 BD07            POP              {R0-R2,PC}
  735 0000029A                 ENDP
  736 0000029A         
  737 0000029A         PutStringSB
                               PROC             {R0-R14},{}
  738 0000029A         ;---------------------------
  739 0000029A         ; Displays a null-terminated string from memory,
  740 0000029A         ; starting at the address where R0 points, to the
  741 0000029A         ; terminal screen.
  742 0000029A         ; Does not print more than MAX_STRING characters
  743 0000029A         ; Input: R0; pointer to source string
  744 0000029A         ; Modify: APSR
  745 0000029A         ; Uses: PutChar
  746 0000029A         ;---------------------------
  747 0000029A B507            PUSH             {R0-R2,LR}
  748 0000029C 0002            MOVS             R2,R0       ;puts the memory address R0 into R2
  749 0000029E         
  750 0000029E         PutStringLoop
  751 0000029E 7810            LDRB             R0,[R2,#0]  ;loads first byte of string stored at R2
  752 000002A0 2800            CMP              R0,#0



ARM Macro Assembler    Page 21 Serial I/O Driver


  753 000002A2 D005            BEQ              EndPutString ;branches on null character
  754 000002A4 F7FF FFFE       BL               PutChar
  755 000002A8 1C52            ADDS             R2,R2,#1    ;increments memory location at R2
  756 000002AA 1E49            SUBS             R1,R1,#1    ;decrements the string length
  757 000002AC D000            BEQ              EndPutString ;ends printing if R1 characters have been printed
  758 000002AE E7F6            B                PutStringLoop ;else branches to loop
  759 000002B0         
  760 000002B0         EndPutString
  761 000002B0 BD07            POP              {R0-R2,PC}
  762 000002B2                 ENDP
  763 000002B2         
  764 000002B2         PutNumU PROC             {R0-R14},{}
  765 000002B2         ;-----------------------
  766 000002B2         ;Prints the decimal representation of the unsigned
  767 000002B2         ;word value in R0.
  768 000002B2         ; Input: R0; value to be printed.
  769 000002B2         ;-----------------------
  770 000002B2 B507            PUSH             {R0-R2,LR}
  771 000002B4 0001            MOVS             R1,R0       ;places value to be printed in R1
  772 000002B6 4A37            LDR              R2,=BILDIV
  773 000002B8 6812            LDR              R2,[R2,#0]  ;loads 1,000,000,000 into R2
  774 000002BA         
  775 000002BA 2800            CMP              R0,#0
  776 000002BC D01E            BEQ              PrintZero   ;Branches if the value to be printed is zero (special case)
  777 000002BE         
  778 000002BE         InitialPutNumULoop
  779 000002BE 0010            MOVS             R0,R2
  780 000002C0 F7FF FFFE       BL               DIVU        ;divides R1 (now holding value to be printed) by R0 (holding
                                                             the maximum power of 10)
  781 000002C4 2900            CMP              R1,#0
  782 000002C6 D02A            BEQ              EndPutNumU  ;branches on remainder 0
  783 000002C8 2800            CMP              R0,#0
  784 000002CA D107            BNE              PrintingLoop ;else branches if R0 is a non0 character
  785 000002CC         
  786 000002CC B403            PUSH{R0-R1}                  ;divides R2/10
  787 000002CE 0011            MOVS             R1,R2
  788 000002D0 200A            MOVS             R0,#10
  789 000002D2 F7FF FFFE       BL               DIVU        ;this decrements the value of R2 so successive divisions
  790 000002D6 0002            MOVS             R2,R0       ;divide by smaller power of 10, getting closer and closer to
                                                             division by 1.
  791 000002D8 BC03            POP              {R0,R1}     ;this gets each digit of the decimal in turn.
  792 000002DA E7F0            B                InitialPutNumULoop



ARM Macro Assembler    Page 22 Serial I/O Driver


  793 000002DC         
  794 000002DC         PrintingLoop
  795 000002DC 3030            ADDS             R0,R0,#48
  796 000002DE F7FF FFFE       BL               PutChar     ;converts quotient to ascii and prints
  797 000002E2         
  798 000002E2 B403            PUSH{R0-R1}                  ;divides R2/10
  799 000002E4 0011            MOVS             R1,R2
  800 000002E6 200A            MOVS             R0,#10
  801 000002E8 F7FF FFFE       BL               DIVU        ;this decrements the value of R2 so successive divisions
  802 000002EC 0002            MOVS             R2,R0       ;divide by smaller power of 10, getting closer and closer to
                                                             division by 1.
  803 000002EE BC03            POP              {R0,R1}     ;this gets each digit of the decimal in turn.
  804 000002F0         
  805 000002F0 0010            MOVS             R0,R2       ;moves R2/10 into R0 (divisor)
  806 000002F2 F7FF FFFE       BL               DIVU
  807 000002F6 2900            CMP              R1,#0       ;branches if remainder == 0
  808 000002F8 D011            BEQ              EndPutNumU
  809 000002FA E7EF            B                PrintingLoop
  810 000002FC         
  811 000002FC         PrintZero                            ;Prints a single zero to the terminal and stops.
  812 000002FC 2030            MOVS             R0,#48
  813 000002FE F7FF FFFE       BL               PutChar
  814 00000302 E011            B                EndPutNumUPrinting
  815 00000304         
  816 00000304         ZeroPrintLoop
  817 00000304 2030            MOVS             R0,#48
  818 00000306 F7FF FFFE       BL               PutChar
  819 0000030A         
  820 0000030A B403            PUSH{R0-R1}                  ;divides R2/10
  821 0000030C 0011            MOVS             R1,R2
  822 0000030E 200A            MOVS             R0,#10
  823 00000310 F7FF FFFE       BL               DIVU        ;this decrements the value of R2 so successive divisions
  824 00000314 0002            MOVS             R2,R0       ;divide by smaller power of 10, getting closer and closer to
                                                             division by 1.
  825 00000316 BC03            POP              {R0,R1}     ;this gets each digit of the decimal in turn.
  826 00000318         
  827 00000318 2A01            CMP              R2,#1
  828 0000031A D1F3            BNE              ZeroPrintLoop
  829 0000031C E004            B                EndPutNumUPrinting
  830 0000031E         
  831 0000031E         EndPutNumU
  832 0000031E 3030            ADDS             R0,R0,#48   ;prints the last character



ARM Macro Assembler    Page 23 Serial I/O Driver


  833 00000320 F7FF FFFE       BL               PutChar
  834 00000324         
  835 00000324 2A01            CMP              R2,#1       ;if R2 != 1, that is, in case 10, 20, ect, then print remain
                                                            ing zeroes.
  836 00000326 D1ED            BNE              ZeroPrintLoop
  837 00000328         EndPutNumUPrinting
  838 00000328 BD07            POP              {R0-R2,PC}
  839 0000032A                 ENDP
  840 0000032A         
  841 0000032A         DIVU    PROC             {R2-R14},{}
  842 0000032A         ;***************************************************************
  843 0000032A         ;divides R1/R0: stores quotient in R0 and remainder in R1
  844 0000032A         ;uses R2 to temporarily store quotient
  845 0000032A         ;sets C flag if an attempt to divide by 0 is detected
  846 0000032A         ;***************************************************************
  847 0000032A 2800            CMP              R0,#0
  848 0000032C D012            BEQ              DIVO        ;checks if divide by 0
  849 0000032E         
  850 0000032E B404            PUSH             {R2}        ;pushes R2 onto stack for quotient tracking
  851 00000330 2200            MOVS             R2,#0       ;empties R2
  852 00000332         
  853 00000332 4281    WHILEDIVU
                               CMP              R1,R0
  854 00000334 D302            BLO              ENDWHILEDIVU ;if R1<R0, branch to the end of program
  855 00000336 1A09            SUBS             R1,R1,R0    ;otherwise, subtract R0 from R1
  856 00000338 1C52            ADDS             R2,R2,#1    ;and add 1 to R2
  857 0000033A E7FA            B                WHILEDIVU
  858 0000033C         
  859 0000033C 0010    ENDWHILEDIVU
                               MOVS             R0,R2
  860 0000033E BC04            POP              {R2}
  861 00000340 B403            PUSH             {R0,R1}
  862 00000342 F3EF 8000       MRS              R0,APSR
  863 00000346 2120            MOVS             R1,#0x20
  864 00000348 0609            LSLS             R1,R1,#24
  865 0000034A 4388            BICS             R0,R0,R1    ;clears C flag
  866 0000034C F380 8800       MSR              APSR,R0     ;sets APSR equal to R0
  867 00000350 BC03            POP              {R1,R0}
  868 00000352 E008            B                ENDDIVU
  869 00000354         
  870 00000354 B403    DIVO    PUSH             {R0,R1}     ;pushes R0 and R1 onto stack
  871 00000356 F3EF 8000       MRS              R0,APSR     ;sets R0 equal to APSR



ARM Macro Assembler    Page 24 Serial I/O Driver


  872 0000035A 2120            MOVS             R1,#0x20
  873 0000035C 0609            LSLS             R1,R1,#24
  874 0000035E 4308            ORRS             R0,R0,R1    ;sets C flag
  875 00000360 F380 8800       MSR              APSR,R0     ;sets APSR equal to R0
  876 00000364 BC03            POP              {R1,R0}     ;pops R0, R1
  877 00000366         
  878 00000366 4770    ENDDIVU BX               LR
  879 00000368                 ENDP
  880 00000368         ;>>>>>   end subroutine code <<<<<
  881 00000368                 ALIGN
  882 00000368         ;****************************************************************
  883 00000368         ;Vector Table Mapped to Address 0 at Reset
  884 00000368         ;Linker requires __Vectors to be exported
  885 00000368 00000000 
              00000000 
              00000000 
              00000000 
              00000000 
              00000000 
              00000000 
              00000000 
              00000000 
              00000000 
              00000000 
              00000000 
              40037100 
              00000001 
              4004803C 
              00800000 
              E000E414 
              00C00000 
              E000E280 
              00400000 
              E000E100 
              40037000 
              0003A97F 
              00000000 
              00000000 
              4006A000 
              00000000 
              00000000 
              00000000 



ARM Macro Assembler    Page 25 Serial I/O Driver


              00000000 
              00000050 
              00000000 
              00000000 
              40048004 
              0C000000 
              04010000 
              40048010 
              00010007 
              40048034 
              00000400 
              40048038 
              00000200 
              40049004 
              01000200 
              40049008 
              E000E40C 
              00001000 
              00000000         AREA             RESET, DATA, READONLY
  886 00000000                 EXPORT           __Vectors
  887 00000000                 EXPORT           __Vectors_End
  888 00000000                 EXPORT           __Vectors_Size
  889 00000000                 IMPORT           __initial_sp
  890 00000000                 IMPORT           Dummy_Handler
  891 00000000                 IMPORT           HardFault_Handler
  892 00000000         __Vectors
  893 00000000         ;ARM core vectors
  894 00000000 00000000        DCD              __initial_sp ;00:end of stack
  895 00000004 00000000        DCD              Reset_Handler ;01:reset vector
  896 00000008 00000000        DCD              Dummy_Handler ;02:NMI
  897 0000000C 00000000        DCD              HardFault_Handler ;03:hard fault
  898 00000010 00000000        DCD              Dummy_Handler ;04:(reserved)
  899 00000014 00000000        DCD              Dummy_Handler ;05:(reserved)
  900 00000018 00000000        DCD              Dummy_Handler ;06:(reserved)
  901 0000001C 00000000        DCD              Dummy_Handler ;07:(reserved)
  902 00000020 00000000        DCD              Dummy_Handler ;08:(reserved)
  903 00000024 00000000        DCD              Dummy_Handler ;09:(reserved)
  904 00000028 00000000        DCD              Dummy_Handler ;10:(reserved)
  905 0000002C 00000000        DCD              Dummy_Handler ;11:SVCall (supervisor call)
  906 00000030 00000000        DCD              Dummy_Handler ;12:(reserved)
  907 00000034 00000000        DCD              Dummy_Handler ;13:(reserved)
  908 00000038 00000000        DCD              Dummy_Handler ;14:PendableSrvReq (pendable request 



ARM Macro Assembler    Page 26 Serial I/O Driver


  909 0000003C         ;   for system service)
  910 0000003C 00000000        DCD              Dummy_Handler ;15:SysTick (system tick timer)
  911 00000040 00000000        DCD              Dummy_Handler ;16:DMA channel 0 xfer complete/error
  912 00000044 00000000        DCD              Dummy_Handler ;17:DMA channel 1 xfer complete/error
  913 00000048 00000000        DCD              Dummy_Handler ;18:DMA channel 2 xfer complete/error
  914 0000004C 00000000        DCD              Dummy_Handler ;19:DMA channel 3 xfer complete/error
  915 00000050 00000000        DCD              Dummy_Handler ;20:(reserved)
  916 00000054 00000000        DCD              Dummy_Handler ;21:command complete; read collision
  917 00000058 00000000        DCD              Dummy_Handler ;22:low-voltage detect;
  918 0000005C         ;   low-voltage warning
  919 0000005C 00000000        DCD              Dummy_Handler ;23:low leakage wakeup
  920 00000060 00000000        DCD              Dummy_Handler ;24:I2C0
  921 00000064 00000000        DCD              Dummy_Handler ;25:I2C1
  922 00000068 00000000        DCD              Dummy_Handler ;26:SPI0 (all IRQ sources)
  923 0000006C 00000000        DCD              Dummy_Handler ;27:SPI1 (all IRQ sources)
  924 00000070 00000000        DCD              UART0_ISR   ;28:UART0 (Tx/Rx)
  925 00000074 00000000        DCD              Dummy_Handler ;29:UART1 (status; error)
  926 00000078 00000000        DCD              Dummy_Handler ;30:UART2 (status; error)
  927 0000007C 00000000        DCD              Dummy_Handler ;31:ADC0
  928 00000080 00000000        DCD              Dummy_Handler ;32:CMP0
  929 00000084 00000000        DCD              Dummy_Handler ;33:TPM0
  930 00000088 00000000        DCD              Dummy_Handler ;34:TPM1
  931 0000008C 00000000        DCD              Dummy_Handler ;35:TPM2
  932 00000090 00000000        DCD              Dummy_Handler ;36:RTC (alarm)
  933 00000094 00000000        DCD              Dummy_Handler ;37:RTC (seconds)
  934 00000098 00000000        DCD              PIT_ISR     ;38:PIT (all IRQ sources)
  935 0000009C 00000000        DCD              Dummy_Handler ;39:I2S0
  936 000000A0 00000000        DCD              Dummy_Handler ;40:USB0
  937 000000A4 00000000        DCD              Dummy_Handler ;41:DAC0
  938 000000A8 00000000        DCD              Dummy_Handler ;42:TSI0
  939 000000AC 00000000        DCD              Dummy_Handler ;43:MCG
  940 000000B0 00000000        DCD              Dummy_Handler ;44:LPTMR0
  941 000000B4 00000000        DCD              Dummy_Handler ;45:Segment LCD
  942 000000B8 00000000        DCD              Dummy_Handler ;46:PORTA pin detect
  943 000000BC 00000000        DCD              Dummy_Handler ;47:PORTC and PORTD pin detect
  944 000000C0         __Vectors_End
  945 000000C0 000000C0 
                       __Vectors_Size
                               EQU              __Vectors_End - __Vectors
  946 000000C0                 ALIGN
  947 000000C0         ;****************************************************************
  948 000000C0         ;Constants



ARM Macro Assembler    Page 27 Serial I/O Driver


  949 000000C0                 AREA             MyConst,DATA,READONLY
  950 00000000         ;>>>>> begin constants here <<<<<
  951 00000000 45 6E 74 
              65 72 20 
              79 6F 75 
              72 20 6E 
              61 6D 65 
              2E 0D 0A 
              3E 00    EnterName
                               DCB              "Enter your name.",CR,LF,">",NULL
  952 00000014 20 78 20 
              30 2E 30 
              31 20 73 
              0D 0A 00 TimeReturn
                               DCB              " x 0.01 s",CR,LF,NULL
  953 00000020 45 6E 74 
              65 72 20 
              74 68 65 
              20 64 61 
              74 65 2E 
              0D 0A 3E 
              00       EnterDate
                               DCB              "Enter the date.",CR,LF,">",NULL
  954 00000033 45 6E 74 
              65 72 20 
              74 68 65 
              20 6C 61 
              73 74 20 
              6E 61 6D 
              65 20 6F 
              66 20 61 
              20 32 35 
              30 20 6C 
              61 62 20 
              54 41 2E 
              0D 0A 3E 
              00       EnterTA DCB              "Enter the last name of a 250 lab TA.",CR,LF,">",NULL
  955 0000005B 54 68 61 
              6E 6B 20 
              79 6F 75 
              2E 20 47 
              6F 6F 64 



ARM Macro Assembler    Page 28 Serial I/O Driver


              62 79 65 
              21 0D 0A 
              00       GoodBye DCB              "Thank you. Goodbye!",CR,LF,NULL
  956 00000071 00 00 00        ALIGN
  957 00000074 3B9ACA00 
                       BILDIV  DCD              0x3B9ACA00
  958 00000078         ;>>>>>   end constants here <<<<<
  959 00000078                 ALIGN
  960 00000078         ;****************************************************************
  961 00000078         ;Variables
  962 00000078                 AREA             MyData,DATA,READWRITE
  963 00000000         ;>>>>> begin variables here <<<<<
  964 00000000 00 00 00 
              00       Count   SPACE            4
  965 00000004                 ALIGN
  966 00000004 00      RunStopWatch
                               SPACE            1
  967 00000005 00 00 00        ALIGN
  968 00000008 00 00 00 
              00 00 00 
              00 00 00 
              00 00 00 
              00 00 00 
              00 00 00 
              00 00 00 
              00 00 00 
              00 00 00 
              00 00 00 
              00 00 00 
              00 00 00 
              00 00 00 
              00 00 00 
              00 00 00 
              00 00 00 
              00 00 00 
              00 00 00 
              00 00 00 
              00 00 00 
              00 00 00 
              00 00 00 
              00 00 00 
              00 00 00 



ARM Macro Assembler    Page 29 Serial I/O Driver


              00 00 00 
              00 00 00 
              00 00    TxQ     SPACE            Tx_Rx_Q_BUF_SZ
  969 00000058                 ALIGN
  970 00000058 00 00 00 
              00 00 00 
              00 00 00 
              00 00 00 
              00 00 00 
              00 00 00 TxQRecord
                               SPACE            Q_REC_SZ
  971 0000006A 00 00           ALIGN
  972 0000006C 00 00 00 
              00 00 00 
              00 00 00 
              00 00 00 
              00 00 00 
              00 00 00 
              00 00 00 
              00 00 00 
              00 00 00 
              00 00 00 
              00 00 00 
              00 00 00 
              00 00 00 
              00 00 00 
              00 00 00 
              00 00 00 
              00 00 00 
              00 00 00 
              00 00 00 
              00 00 00 
              00 00 00 
              00 00 00 
              00 00 00 
              00 00 00 
              00 00 00 
              00 00 00 
              00 00    RxQ     SPACE            Tx_Rx_Q_BUF_SZ
  973 000000BC                 ALIGN
  974 000000BC 00 00 00 
              00 00 00 



ARM Macro Assembler    Page 30 Serial I/O Driver


              00 00 00 
              00 00 00 
              00 00 00 
              00 00 00 RxQRecord
                               SPACE            Q_REC_SZ
  975 000000CE 00 00           ALIGN
  976 000000D0 00 00 00 
              00 00 00 
              00 00 00 
              00 00 00 
              00 00 00 
              00 00 00 
              00 00 00 
              00 00 00 
              00 00 00 
              00 00 00 
              00 00 00 
              00 00 00 
              00 00 00 
              00 00 00 
              00 00 00 
              00 00 00 
              00 00 00 
              00 00 00 
              00 00 00 
              00 00 00 
              00 00 00 
              00 00 00 
              00 00 00 
              00 00 00 
              00 00 00 
              00 00 00 
              00       MyString
                               SPACE            MAX_STRING
  977 0000011F         
  978 0000011F         ;>>>>>   end variables here <<<<<
  979 0000011F 00              ALIGN
  980 00000120                 END
Command Line: --debug --length=49 --width=120 --diag_suppress=9931 --cpu=Cortex-M0+ --apcs=interwork --depend=.\objects\
exercise10.d -o.\objects\exercise10.o -I.\RTE\_Target_1 -IC:\Keil_v5\ARM\PACK\Keil\Kinetis_KLxx_DFP\1.6.0\Device\Include
 -IC:\Keil_v5\ARM\CMSIS\Include --predefine="__EVAL SETA 1" --predefine="__UVISION_VERSION SETA 524" --predefine="MKL46Z
256xxx4 SETA 1" --list=.\listings\exercise10.lst Exercise10.s
